experiment_id = 2;

name = 'Global and Local Lexical Substitution';
description = 'Examine how global and local lexical substitution perform alone and in combination. ';

S = { {'GlobalLexicalKnnSubstitution', 'LocalLexicalKnnSubstitution'},  {'vocBefore', 'info.vocSizeBefore', 'vocAfter', 'info.vocSizeAfter', 'LVi', 'info.LVi'} };
scheme = ReportScheme(S{:});
for i=1:numel(Ws)  
    W = Ws{i};
    p = sequence(  ...
        select(@(s) mini(cellfun(@(y) y.Out.loss, s)), ... 
               sequence(fork(pgrid('ExcludeWords', 'MinCount', num2cell(1:3), 'MaxCount', {Inf})), ...
                        TfIdf(), ...
                        SVMClassifier('KFold', 10) )), ...
        fork(nop(), ...
             sequence(LocalLexicalKnnSubstitution('K', 10, 'MaxIter', 10, 'DictDeltaThresh', 10), nop()), ...
             sequence( ...
                       fork(pgrid('GlobalLexicalKnnSubstitution', 'K', num2cell([150, 100, 50, 30, 20]), 'sigma', {@(x,y,z) (x+y), @(x,y,z) (x+y)./exp(1.3*z)})), ...
                       fork(nop(),LocalLexicalKnnSubstitution('K', 10, 'MaxIter', 10, 'DictDeltaThresh', 10)))), ...
        fork(TfIdf(), WordCountMatrix(), TfIdfVectorizer()), ...
        SVMClassifier('CrossvalParams', {'KFold', 10}));
    
    dataset = business_signals{i};
    r = ExperimentReport(experiment_id, dataset, name, 'Lexical Substitution', scheme);
    P = pipeline(p);
    figure; plot(P.Graph);
    P.execute(W, r);
    
    %store.add(r);
end