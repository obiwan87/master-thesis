[
  {
    $match:{
      ExperimentId:9
    }
  },
  {
    $unwind:"$Steps"
  },
  {
    $project:{
      method:{
        $arrayElemAt:[
          "$Steps.Name",
          0
        ]
      },
      dataset:"$Dataset",
      accuracy:"$Steps.Out.accuracy",
      classifier:{
        $arrayElemAt:[
          "$Steps.Name",
          -1
        ]
      },
      keepUnigrams:{
        $arrayElemAt:[
          "$Steps.Args.keepunigrams",
          0
        ]
      },
      nbest:{
        $arrayElemAt:[
          "$Steps.Args.nbest",
          0
        ]
      },
      scoreFcn:{
        $arrayElemAt:[
          "$Steps.Args.scorefcn",
          0
        ]
      }
    }
  },
  {
    $match:{
      method:"NGrams"
    }
  },
  {
    $unwind:"$accuracy"
  },
  {
    $project:{
      accuracy:1,
      classifier:1,
      dataset:1,
      scoreFcn:{
        "$ifNull":[
          "$scoreFcn",
          "na"
        ]
      },
      keepUnigrams:{
        "$ifNull":[
          "$keepUnigrams",
          0
        ]
      },
      nbest:{
        "$ifNull":[
          "$nbest",
          0
        ]
      }
    }
  },
  {
    $sort:{
      dataset:1,
      nbest:1
    }
  },
  {
    $group:{
      _id:{
        classifier:"$classifier",
        dataset:"$dataset",
        keepUnigrams:"$keepUnigrams",
        scoreFcn:"$scoreFcn"
      },
      accuracy:{
        $push:"$accuracy"
      },
      nbest:{
        $push:"$nbest"
      }
    }
  }
,
  {
    $project:{
      method:"$_id.method",
      nbest:1,
      accuracy:1,
      _id:0,
      classifier:"$_id.classifier",
      dataset:"$_id.dataset",
      keepUnigrams:"$_id.keepUnigrams",
      scoreFcn:"$_id.scoreFcn"
    }
  },
  {
    $sort:{
      dataset:1
    }
  },
  {
    $group:{
      _id:{
        classifier:"$classifier",
        keepUnigrams:"$keepUnigrams",
        scoreFcn:"$scoreFcn"
      },
      accuracies:{
        $push:"$accuracy"
      },
      dataset:{
        $push:"$dataset"
      },
      nbest:{
        $first:"$nbest"
      }
    }
  },
  {
    $group:{
      _id:{
        classifier:"$_id.classifier"
      },
      accuracies:{
        $push:"$accuracies"
      },
      dataset:{
        $push:"$dataset"
      },
      keepUnigrams:{
        $push:"$_id.keepUnigrams"
      },
      scoreFcn:{
        $push:"$_id.scoreFcn"
      },
      nbest:{
        $first:"$nbest"
      }
    }
  },
  {
    $sort:{
      "_id.classifier":1
    }
  }
]